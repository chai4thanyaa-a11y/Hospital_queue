<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Portal - Hospital Queue</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .portal-container {
            max-width: 800px;
            margin: 50px auto;
            text-align: center;
        }

        .department-select {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .consultation-room {
            display: none;
        }

        .patient-card {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border-left: 10px solid var(--primary-color);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <header>
        <div class="container d-flex" style="justify-content: space-between; align-items: center;">
            <h1>üë®‚Äç‚öïÔ∏è Doctor Portal</h1>
            <button onclick="logout()" class="secondary" style="width: auto; padding: 5px 10px;">Logout</button>
        </div>
    </header>

    <div class="container portal-container">

        <!-- Department Selection -->
        <div id="dept-gate" class="department-select">
            <h2>Select Your Department</h2>
            <br>
            <div class="form-group">
                <select id="doc-dept" style="padding: 15px; font-size: 1.2rem;">
                    <option value="Cardiology">Cardiology</option>
                    <option value="Dermatology">Dermatology</option>
                    <option value="ENT">ENT</option>
                    <option value="General">General Medicine</option>
                    <option value="Gynecology">Gynecology</option>
                    <option value="Neurology">Neurology</option>
                    <option value="Oncology">Oncology</option>
                    <option value="Ophthalmology">Ophthalmology</option>
                    <option value="Orthopedic">Orthopedic</option>
                    <option value="Pediatrics">Pediatrics</option>
                    <option value="Psychiatry">Psychiatry</option>
                    <option value="Radiology">Radiology</option>
                    <option value="Urology">Urology</option>
                </select>
            </div>
            <button onclick="enterPortal()">Enter Consultation Room</button>
        </div>

        <!-- Consultation Room -->
        <div id="consultation-room" class="consultation-room">
            <h2 id="room-title">General Medicine Room</h2>

            <div class="patient-card">
                <p>Current Patient</p>
                <div id="current-patient-display">
                    <h1 style="color: #ccc;">Waiting...</h1>
                </div>
            </div>

            <div class="controls">
                <button class="secondary" onclick="completeConsultation()"
                    style="background-color: var(--success-color);">‚úÖ Finish Consultation</button>
                <button onclick="callNext()">üì¢ Call Next Patient</button>
            </div>

            <div style="margin-top: 30px; text-align: left;">
                <h3>Waiting Next:</h3>
                <ul id="next-list" style="list-style: none; padding: 0; color: #666;">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="assets/js/queue.js"></script>
    <script src="assets/js/navbar.js"></script>
    <script>
        // AUTH CHECK
        if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'doctor') {
            window.location.href = 'login.html';
        }

        let currentDept = localStorage.getItem('dept') || "General";
        // If doctor was registered with a specific dept, force it? 
        // For flexibility, let them choose if not set, or pre-select.

        // If localStorage has dept from login, use it and skip select
        const storedDept = localStorage.getItem('dept');
        if (storedDept && storedDept !== 'undefined') {
            currentDept = storedDept;
            document.getElementById('doc-dept').value = currentDept;
            // Optional: Auto-enter?
            // enterPortal(); 
        }

        function enterPortal() {
            currentDept = document.getElementById('doc-dept').value;
            document.getElementById('dept-gate').style.display = 'none';
            document.getElementById('consultation-room').style.display = 'block';
            document.getElementById('room-title').innerText = `${currentDept} Room`;

            refreshRoom();
            setInterval(refreshRoom, 5000);
        }

        async function refreshRoom() {
            const queue = await queueManager.getQueue(currentDept);
            renderRoom(queue);
        }

        function renderRoom(queue) {
            const currentDisplay = document.getElementById('current-patient-display');
            const nextList = document.getElementById('next-list');

            // Current
            const serving = queue.find(p => p.status === 'serving');
            if (serving) {
                currentDisplay.innerHTML = `
                    <h1 style="font-size: 3rem; color: var(--primary-color);">${serving.token}</h1>
                    <h3>${serving.name} (${serving.age} yrs)</h3>
                    ${serving.urgency === 'Critical' ? '<span style="color:red; font-weight:bold;">üî¥ CRITICAL</span>' : ''}
                `;
            } else {
                currentDisplay.innerHTML = `<h1 style="color: #ccc;">Waiting for next...</h1>`;
            }

            // Waiting
            const waiting = queue.filter(p => p.status === 'waiting');
            nextList.innerHTML = '';
            if (waiting.length === 0) {
                nextList.innerHTML = '<li>No patients waiting.</li>';
            } else {
                waiting.slice(0, 5).forEach(p => {
                    const li = document.createElement('li');
                    li.style.padding = '10px';
                    li.style.borderBottom = '1px solid #eee';
                    li.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${p.token}</strong> 
                                ${p.urgency === 'Critical' ? 'üî¥' : ''}
                                - ${p.name} (${p.age} yrs)
                            </div>
                        </div>
                    `;
                    nextList.appendChild(li);
                });
            }
        }

        async function callNext() {
            const patient = await queueManager.callNext(currentDept);
            if (patient) {
                const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                audio.play();
                refreshRoom();
            } else {
                alert("No patients waiting!");
            }
        }

        async function completeConsultation() {
            // Find current serving
            const queue = await queueManager.getQueue(currentDept);
            const serving = queue.find(p => p.status === 'serving');
            if (serving) {
                await queueManager.updateStatus(serving._id, 'completed');
                refreshRoom();
            } else {
                alert("No patient is currently being served.");
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('dept');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>