<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Hospital Queue</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }

        .stats-card {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 20px;
        }

        .dept-list button {
            text-align: left;
            margin-bottom: 10px;
            background: white;
            color: var(--dark-text);
            border: 1px solid #eee;
        }

        .dept-list button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-bar {
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>
    <header>
        <div class="container d-flex" style="justify-content: space-between; align-items: center;">
            <h1>üè¢ Admin Dashboard</h1>
            <div>
                <span id="admin-name" style="color: white; margin-right: 15px;"></span>
                <button onclick="resetSystem()" class="secondary"
                    style="width: auto; padding: 5px 10px; margin-right: 10px; background: #dc2626; color: white; border: none;">‚ö†Ô∏è
                    Reset Queue</button>
                <button onclick="logout()" class="secondary" style="width: auto; padding: 5px 10px;">Logout</button>
            </div>
        </div>
    </header>

    <div class="container dashboard-grid">
        <!-- Sidebar -->
        <aside>
            <div class="stats-card">
                <h3>Total Waiting</h3>
                <h1 style="font-size: 3rem;" id="total-waiting">0</h1>
            </div>

            <div class="tab-nav" style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="switchTab('queue')" id="tab-queue" class="active" style="flex: 1;">Queue</button>
                <button onclick="switchTab('history')" id="tab-history"
                    style="flex: 1; background: white; color: var(--dark-text); border: 1px solid #ddd;">History</button>
            </div>

            <div id="sidebar-depts">
                <h3>Departments</h3>
                <div class="dept-list" id="dept-list">
                    <!-- Departments generated by JS -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- QUEUE VIEW -->
            <div id="view-queue">
                <div class="action-bar">
                    <h2 id="current-dept-title">General Medicine</h2>
                    <div>
                        <button onclick="callNext()" class="mt-2" style="width: auto; padding: 10px 20px;">üì¢ Call Next
                            Patient</button>
                    </div>
                </div>

                <!-- Current Serving -->
                <div class="card" id="serving-card"
                    style="border-left: 5px solid var(--success-color); background: #f0fff4;">
                    <div class="card-header" style="color: var(--success-color);">Now Serving</div>
                    <div id="serving-info">
                        <h2>No patient carrying out</h2>
                    </div>
                    <button id="complete-btn" onclick="completeCurrent()"
                        style="display: none; width: auto; background: var(--success-color); margin-top: 10px;">‚úÖ Mark
                        Completed</button>
                </div>

                <!-- Waiting Queue -->
                <div class="card">
                    <div class="card-header">Waiting List</div>
                    <ul class="queue-list" id="waiting-list">
                        <!-- List items generated by JS -->
                    </ul>
                </div>
            </div>

            <!-- HISTORY VIEW -->
            <div id="view-history" style="display: none;">
                <div class="card">
                    <div class="card-header">üìú Patient History</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                                    <th style="padding: 10px; text-align: left;">Token</th>
                                    <th style="padding: 10px; text-align: left;">Name</th>
                                    <th style="padding: 10px; text-align: left;">Dept</th>
                                    <th style="padding: 10px; text-align: left;">Age</th>
                                    <th style="padding: 10px; text-align: left;">Completed At</th>
                                    <th style="padding: 10px; text-align: left;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-list">
                                <!-- History items generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="assets/js/queue.js"></script>
    <script src="assets/js/navbar.js"></script>
    <script>
        // AUTH CHECK
        if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'admin') {
            window.location.href = 'login.html';
        }

        let currentDept = "General";
        // Map to store current state
        let allQueues = {};

        let currentView = 'queue';

        async function init() {
            await refreshData();
            renderDepartments();
            renderQueue();

            // Poll
            setInterval(async () => {
                await refreshData();
                renderDepartments();
                renderQueue();
                if (currentView === 'history') renderHistory(); // Also refresh history if active
            }, 5000);
        }

        async function refreshData() {
            allQueues = await queueManager.getAllQueues();
        }

        function switchTab(view) {
            currentView = view;
            const btnQueue = document.getElementById('tab-queue');
            const btnHistory = document.getElementById('tab-history');
            const viewQueue = document.getElementById('view-queue');
            const viewHistory = document.getElementById('view-history');
            const sidebarDepts = document.getElementById('sidebar-depts');

            if (view === 'queue') {
                btnQueue.classList.add('active');
                btnQueue.style.background = 'var(--primary-color)';
                btnQueue.style.color = 'white';

                btnHistory.classList.remove('active');
                btnHistory.style.background = 'white';
                btnHistory.style.color = 'var(--dark-text)';

                viewQueue.style.display = 'block';
                viewHistory.style.display = 'none';
                sidebarDepts.style.display = 'block';
            } else {
                btnHistory.classList.add('active');
                btnHistory.style.background = 'var(--primary-color)';
                btnHistory.style.color = 'white';

                btnQueue.classList.remove('active');
                btnQueue.style.background = 'white';
                btnQueue.style.color = 'var(--dark-text)';

                viewQueue.style.display = 'none';
                viewHistory.style.display = 'block';
                sidebarDepts.style.display = 'none'; // Hide departments in history view to give more space? Or keep it.
                // Let's hide sidebar depts for cleaner history view

                renderHistory();
            }
        }

        async function renderHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>';

            const history = await queueManager.getHistory(); // Fetch from backend

            if (history.length === 0) {
                historyList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #888;">No history found</td></tr>';
                return;
            }

            historyList.innerHTML = history.map(p => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px; font-weight: bold;">${p.token}</td>
                    <td style="padding: 10px;">${p.name}</td>
                    <td style="padding: 10px;">${p.department}</td>
                    <td style="padding: 10px;">${p.age}</td>
                    <td style="padding: 10px; color: #666;">${p.completedAt ? new Date(p.completedAt).toLocaleString() : new Date(p.joinedAt).toLocaleString()}</td>
                    <td style="padding: 10px;"><span style="background: #dcfce7; color: #16a34a; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">${p.status.toUpperCase()}</span></td>
                </tr>
            `).join('');
        }

        function renderDepartments() {
            const list = document.getElementById('dept-list');
            list.innerHTML = '';
            // ... (rest of renderDepartments)
            // Sort depts alphabetically
            const depts = Object.keys(allQueues).sort();

            if (depts.length === 0) {
                list.innerHTML = '<p style="color: #888;">No active queues.</p>';
            }

            let totalWaiting = 0;

            depts.forEach(dept => {
                const queue = allQueues[dept];
                const waitingCount = queue.filter(p => p.status === 'waiting').length;
                totalWaiting += waitingCount;

                const btn = document.createElement('button');
                btn.innerHTML = `<strong>${dept}</strong> <span style="float: right; badge">${waitingCount}</span>`;
                btn.onclick = () => switchDept(dept);
                if (dept === currentDept) btn.classList.add('active');
                list.appendChild(btn);
            });

            document.getElementById('total-waiting').innerText = totalWaiting;
        }

        function switchDept(dept) {
            currentDept = dept;
            document.getElementById('current-dept-title').innerText = dept;
            renderDepartments();
            renderQueue();
        }

        function renderQueue() {
            // ... (rest of renderQueue)
            // Copying existing renderQueue logic or assuming it remains as is?
            // The tool replaces a large chunk, so I must include the existing functions if I'm replacing the block containing them.
            // Wait, I am replacing from 'async function init()' to the logout function.
            // I need to provide the full content for the replaced block.

            // To be safe and efficient, I will only output the 'renderQueue' start and rely on the tool finding the end? 
            // No, I need to provide the full replacement.
            // I will paste the original `renderQueue` code here.

            const queue = allQueues[currentDept] || [];
            const waitingList = document.getElementById('waiting-list');
            const servingInfo = document.getElementById('serving-info');
            const completeBtn = document.getElementById('complete-btn');

            waitingList.innerHTML = '';

            // Find serving
            const serving = queue.find(p => p.status === 'serving');
            if (serving) {
                servingInfo.innerHTML = `
                    <h1 style="font-size: 2.5rem;">${serving.token}</h1>
                    <p><strong>Name:</strong> ${serving.name} | <strong>Age:</strong> ${serving.age}</p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">üïí Joined: ${new Date(serving.joinedAt).toLocaleTimeString()}</p>
                `;
                completeBtn.onclick = () => completeSpecific(serving._id);
                completeBtn.style.display = 'inline-block';
            } else {
                servingInfo.innerHTML = `<h2>Waiting for next patient...</h2>`;
                completeBtn.style.display = 'none';
            }

            // List waiting
            const waiting = queue.filter(p => p.status === 'waiting');
            if (waiting.length === 0) {
                waitingList.innerHTML = '<li style="text-align: center; padding: 20px; color: #888;">No patients in queue</li>';
            } else {
                waiting.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'queue-item';

                    const urgencyBadge = p.urgency === 'Critical'
                        ? '<span style="background:red; color:white; padding:2px 6px; border-radius:4px; font-size:0.7em; margin-left:5px;">CRITICAL</span>'
                        : '';

                    li.innerHTML = `
                        <div style="flex-grow: 1;">
                            <span class="token-badge">${p.token}</span>
                            <span style="margin-left: 10px; font-weight: bold; color: #333;">${p.name}</span>
                            ${urgencyBadge}
                            <span style="color: #666; font-size: 0.9em;">(${p.age} yrs)</span>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                                üïí Joined: ${new Date(p.joinedAt).toLocaleTimeString()}
                            </div>
                        </div>
                        <div>
                            <button class="secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="removePatient('${p._id}')">‚ùå</button>
                        </div>
                    `;
                    waitingList.appendChild(li);
                });
            }
        }

        async function callNext() {
            const patient = await queueManager.callNext(currentDept);
            if (patient) {
                const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                audio.play().catch(e => console.log("Audio play failed", e));
                alert(`Calling Token ${patient.token}: ${patient.name}`);
                await refreshData();
                renderDepartments();
                renderQueue();
            } else {
                alert("No waiting patients in this department!");
            }
        }

        async function completeCurrent() {
            const queue = allQueues[currentDept] || [];
            const serving = queue.find(p => p.status === 'serving');
            if (serving) {
                await queueManager.updateStatus(serving._id, 'completed');
                await refreshData();
                renderDepartments();
                renderQueue();
            }
        }

        async function completeSpecific(id) {
            await queueManager.updateStatus(id, 'completed');
            await refreshData();
            renderDepartments();
            renderQueue();
        }

        async function removePatient(id) {
            if (confirm("Remove this patient from queue?")) {
                await queueManager.removePatient(id);
                await refreshData();
                renderQueue();
                renderDepartments();
            }
        }

        async function resetSystem() {
            if (confirm("‚ö†Ô∏è DANGER: This will delete ALL patients and reset token counters to 1.\n\nAre you sure you want to reset the system?")) {
                const success = await queueManager.resetQueue();
                if (success) {
                    alert("System Reset Successful. Token counter is now 1.");
                    refreshData();
                    renderDepartments();
                    renderQueue();
                } else {
                    alert("Failed to reset system.");
                }
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('dept');
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>

</html>